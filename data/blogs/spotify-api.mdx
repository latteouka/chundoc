import Image from "next/image";

## ç›®æ¨™

æ‹¿åˆ°è‡ªå·±çš„ Spotify ç¾åœ¨æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²è³‡è¨Šã€‚

## Authorization Code Flow

ä¸‹åœ–æ˜¯ Spotify for Developers æä¾›çš„[Authorization Code Flow](https://developer.spotify.com/documentation/general/guides/authorization/code-flow/)ï¼Œæ­£å¸¸ä¾†èªªä½¿ç”¨é€™å€‹æµç¨‹æ˜¯ç‚ºäº†è®“æˆ‘å€‘åšçš„ App å¯ä»¥è®“ä½¿ç”¨è€…ç™»å…¥ï¼Œç„¶å¾Œç²å–ä»–çš„ Access Token ä»¥å¾Œï¼Œå°±èƒ½æ‹¿ä»–çš„èº«ä»½ä½¿ç”¨ APIï¼Œé€²ä¸€æ­¥æŠŠç²å–çš„è³‡è¨Šç”¨åœ¨ App ä¸Šï¼Œä½†ç¾åœ¨æˆ‘è¦çš„æ˜¯èƒ½æŒçºŒç”¨æˆ‘è‡ªå·±çš„èº«ä»½ä¾†ä½¿ç”¨ APIï¼Œæ‰€ä»¥æˆ‘éœ€è¦æ‹¿åˆ°çš„æ˜¯æ­¥é©ŸäºŒè¿”é‚„å›ä¾†çš„ Refresh Tokenï¼Œä¹‹å¾Œæˆ‘å°±èƒ½ç”¨é€™å€‹ Refresh Token è¦æ±‚åˆ°æœ€æ–°æ²’éæœŸçš„ Access Token ä¾†ä½¿ç”¨ APIã€‚

<Image
  alt={`spotify auth flow`}
  src={`/img/spotify-auth-flow.png`}
  width={672}
  height={610}
  priority
/>

## æ–°å¢ APP

å…ˆä¾†åˆ° Spotify for Developers çš„[Dashboard](https://developer.spotify.com/dashboard/)ã€‚

- ç™»å…¥å¾Œ Create an Appã€‚
- é»é¸ Show Client Secretã€‚
- æŠŠ Client ID è·Ÿ Secret è¨˜ä¸‹ä¾†ç­‰ç­‰æœƒç”¨åˆ°ã€‚
- åœ¨ Edit Settings è£¡é¢çš„ redirect URI åŠ å…¥ `http://localhost:3000`ã€‚

## é€²è¡Œé©—è­‰

è·Ÿ Spotify ç”¨ä¸‹åˆ—çš„ç¶²å€åšé©—è­‰è¦æ±‚ï¼Œè¨˜å¾—æŠŠ`CLIENT_ID`æ›¿æ›æˆä½ å‰›å‰›è¨˜ä¸‹çš„ï¼Œå¦å¤– Scope é€™é‚Šåªæœ‰è¦æ±‚`user-read-currently-playing`è€Œå·²ï¼Œå¦‚æœä½ ä¹‹å¾Œæœ‰åˆ¥çš„éœ€æ±‚è¨˜å¾—é‡æ–°é©—è­‰ã€‚

```bash
https://accounts.spotify.com/authorize?client_id=CLIENT_ID&response_type=code&redirect_uri=http
%3A%2F%2Flocalhost:3000&scope=user-read-currently-playing
```

ç™»å…¥æˆåŠŸå¾Œä½ æœƒç™¼ç¾é é¢è¢«è½‰å›åˆ°`http://localhost:3000/`ï¼Œä½†ç¶²å€å¾Œé¢å¤šäº†ä¸€ä¸²çš„ code å…§å®¹ï¼Œè«‹æŠŠä»–å­˜ä¸‹ä¾†ã€‚å…¶å¯¦æ‡‰è©²å…ˆè«‹ä½ æº–å‚™å¥½ä¸‹ä¸€æ­¥çš„ï¼Œå› ç‚ºé€™å€‹ code ä¸è¶•å¿«æ‹¿ä¾†ç”¨çš„è©±æœƒéæœŸ ğŸ˜†

```bash
http://localhost:3000/?code=AQAetqp-KRnpLn15riDsCuVDbr36Gkf3nbNyStaQmPihWdU16yRnFwgdW8cN5B7n_2O5EieihFLiBXBJF4kBcHXtzmlOok2WEYt2VbciSdNeAUKHAjYh_Yfx_pLB3UHL6pt3M4WN2PeqcF3XQvqdxF1Auo_29HZbvU0DlAbc-vFcPLcALZg68YtgroD6BRnJUIDazscx
```

## refresh_token

ç™»å…¥æˆåŠŸå¾Œï¼Œå†ä¾†å°±æ˜¯è¦æ­£å¼åšæ­¥é©Ÿ 2 äº†ï¼Œå¾åœ–ç‰‡ä¸­å¯ä»¥çœ‹åˆ°éœ€è¦`client_id`ã€`client_secret`ã€`grant_type`ã€å‰›å‰›å–å¾—çš„`code`åŠ`redirect_uri`ï¼Œè©³ç´°è¦ POST çš„å…§å®¹å¯ä»¥çœ‹[é€™è£¡](https://developer.spotify.com/documentation/general/guides/authorization/code-flow/)çš„**Request Access Token**ã€‚

```bash
curl -H "Authorization: Basic <base64 encoded client_id:client_secret>"
-d grant_type=authorization_code -d code=<code> -d redirect_uri=http%3A
%2F%2Flocalhost:3000 https://accounts.spotify.com/api/token
```

ä¸Šé¢ client_id åŠ client_secret åˆä½µçš„ base64 encode å¯ä»¥ç”¨é€™å€‹[ç·šä¸Šå·¥å…·](https://www.base64encode.org/)ä¾†å¹«ä½ åšï¼Œè¦æ³¨æ„å·¦å³æ‹¬è™Ÿè¦åœ¨è²¼ä¸Šå¾Œæ‹¿æ‰å–”ï¼

curl å¾Œä½ å°±æœƒå¾—åˆ°å«æœ‰ refresh_token çš„ jsonï¼Œé€™å€‹ refresh_token æ²’æœ‰ä¸»å‹•å» revoke çš„è©±æ˜¯ä¸æœƒéæœŸçš„ï¼Œå­˜èµ·ä¾†ä»¥å¾Œéƒ½èƒ½æ‹¿ä¾†ç”¨ä¾†è¦æ±‚æ–°çš„ access_tokenï¼Œä½ ä¹Ÿå¯ä»¥å¾ json è£¡é¢ç™¼ç¾è¦æ±‚å›ä¾†çš„ access_token æ˜¯ä¸€å€‹å°æ™‚æœƒéæœŸã€‚

```js
{
  "access_token":"xxxxx",
  "token_type":"Bearer",
  "expires_in":3600,
  "refresh_token":"xxxxx",
  "scope":"user-read-currently-playing"
}
```

## ä½¿ç”¨ token

è¬ä¸€ä¹‹å¾Œ access_token åˆ°æœŸäº†ï¼Œå¯ä»¥ç”¨ Spotify æä¾›çš„[Request a refreshed Access Token](https://developer.spotify.com/documentation/general/guides/authorization/code-flow/)é‡æ–°è¦ä¸€å€‹ã€‚

```js
const client_id = process.env.SPOTIFY_CLIENT_ID;
const client_secret = process.env.SPOTIFY_CLIENT_SECRET;
const refresh_token = process.env.SPOTIFY_REFRESH_TOKEN;

const TOKEN_URL = `https://accounts.spotify.com/api/token`;

//ç”¨Buffer.from()ä¾†æŠŠStringè½‰ç‚ºäºŒé€²åˆ¶çš„ç·©è¡å€ï¼Œå°±èƒ½å†è½‰æ›æˆåˆ¥çš„ç·¨ç¢¼
const basic = Buffer.from(`${client_id}:${client_secret}`).toString("base64");

const getAccessToken = async () => {
  const response = await fetch(TOKEN_URL, {
    method: "POST",
    headers: {
      Authorization: `Basic ${basic}`,
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: new URLSearchParams({
      grant_type: "refresh_token",
      refresh_token,
    }),
  });

  return response.json();
};
```

åœ¨ token çš„æœ‰æ•ˆæœŸé–“å…§ï¼Œå°±èƒ½è·Ÿ API è¦æˆ‘å€‘æ­£åœ¨æ”¶è½çš„æ­Œæ›²å›‰ã€‚ä½†å› ç‚º refresh_token æ ¹æœ¬ä¸æœƒåˆ°æœŸï¼Œæ‰€ä»¥æ¯æ¬¡ç›´æ¥å°±è¦ä¸€å€‹æ–°çš„ä¾†ç”¨å•¦ã€‚

```js
const NOW_PLAYING_URL = `https://api.spotify.com/v1/me/player/currently-playing`;

const getNowPlaying = async () => {
  const { access_token } = await getAccessToken();

  return fetch(NOW_PLAYING_URL, {
    headers: {
      Authorization: `Bearer ${access_token}`,
    },
  });
};
```
